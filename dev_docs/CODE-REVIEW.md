# Code Review: Compze.Build.FlexRef

## Overall Assessment

This is a well-designed, well-documented project that solves a real problem clearly. The architecture is clean, the MSBuild integration is clever, and the documentation (README, design doc, examples) is excellent. The codebase is small, focused, and avoids over-engineering. Below are findings organized by severity.

---

### 1. Mutable static state — non-resettable singleton pattern

ManagedProject.cs: `_flexReferences` and `_allProjects` are static fields that can only be set once (the guard throws on re-scan). This works fine for a single CLI invocation, but it's a hidden coupling — `SyncCommand` depends on `ScanAndResolveFlexReferences` having been called earlier, with the results accessed later via static properties from `CsprojUpdater`, `NCrunchUpdater`, `DirectoryBuildPropsFileUpdater`, etc.

This isn't a bug today (the CLI runs once and exits), but it makes the code harder to reason about and impossible to test in isolation. Consider passing the resolved data explicitly rather than relying on ambient static state.

## Design Concerns

## Bugs / Correctness Issues

### 6. `Version="*-*"` in generated PackageReference

`ManagedProject.CsprojUpdater.cs` line 78: Generated flex references use `Version="*-*"` (floating, including prereleases). This means:

- Builds are non-deterministic — two developers can get different package versions.
- CI builds that use PackageReference mode will resolve whatever latest version exists.
- No lock file is generated by default.

This is clearly a conscious design choice (you don't want to manage version pinning in the tool), but it's worth at least a prominent callout in the README. For production use, consumers would need to use `Directory.Packages.props` (Central Package Management) or a lock file to get reproducible builds.

### 7. Original package version is discarded during csproj update

`ManagedProject.CsprojUpdater.cs` lines 23–29: `RemoveExistingFlexReferences` strips all matching `PackageReference` and `ProjectReference` elements, then `AppendFlexReferencePairs` writes them back with `Version="*-*"`. If a user had `Version="2.1.0"` pinned, it's silently overwritten. This compounds issue #6 — running `flexref sync` is destructive to version information. Consider preserving the original version if one was present.

### 10. No `--dry-run` or diff mode

The tool modifies files in place with no preview option. For a tool that rewrites `.csproj` and `Directory.Build.props` files, a `--dry-run` flag showing what would change would build user confidence. Not a bug, but a significant UX gap.

---

## Robustness / Edge Cases

## CI / Build Pipeline

### 14. No test project for the CLI tool itself

The only tests are the example Acme.* tests that exercise the *output* of the tool indirectly (do the generated csproj files build?). There are no unit tests for the tool's logic — parsing, resolving, updating. For a tool that generates MSBuild boilerplate, regression tests comparing expected vs actual XML output would catch bugs early.

---