# Code Review: Compze.Build.FlexRef

## Overall Assessment

This is a well-designed, well-documented project that solves a real problem clearly. The architecture is clean, the MSBuild integration is clever, and the documentation (README, design doc, examples) is excellent. The codebase is small, focused, and avoids over-engineering. Below are findings organized by severity.

---

## Design Concerns

### 6. `Version="*-*"` in generated PackageReference

`ManagedProject.CsprojUpdater.cs` line 78: Generated flex references use `Version="*-*"` (floating, including prereleases). This means:

- Builds are non-deterministic — two developers can get different package versions.
- CI builds that use PackageReference mode will resolve whatever latest version exists.
- No lock file is generated by default.

This is clearly a conscious design choice (you don't want to manage version pinning in the tool), but it's worth at least a prominent callout in the README. For production use, consumers would need to use `Directory.Packages.props` (Central Package Management) or a lock file to get reproducible builds.

### 7. Original package version is discarded during csproj update

`ManagedProject.CsprojUpdater.cs` lines 23–29: `RemoveExistingFlexReferences` strips all matching `PackageReference` and `ProjectReference` elements, then `AppendFlexReferencePairs` writes them back with `Version="*-*"`. If a user had `Version="2.1.0"` pinned, it's silently overwritten. This compounds issue #6 — running `flexref sync` is destructive to version information. Consider preserving the original version if one was present.

### 8. Duplicated `DirectoriesToSkip` array

`ManagedProject.Scanner.cs` line 9 and `SlnxSolution.Scanner.cs` line 9 both define `["bin", "obj", "node_modules", ".git", ".vs", ".idea"]`. Extract to a shared constant.

### 10. No `--dry-run` or diff mode

The tool modifies files in place with no preview option. For a tool that rewrites `.csproj` and `Directory.Build.props` files, a `--dry-run` flag showing what would change would build user confidence. Not a bug, but a significant UX gap.

---

## Robustness / Edge Cases

### 11. `FlexRefConfigurationFile.Load()` doesn't validate root element name

`FlexRefConfigurationFile.cs` line 40: The code checks that a root element exists but doesn't verify it's `<FlexRef>`. A stray XML file named `FlexRef.config.xml` with `<Project>` as root would silently produce no results rather than warning the user.

## CI / Build Pipeline

### 14. No test project for the CLI tool itself

The only tests are the example Acme.* tests that exercise the *output* of the tool indirectly (do the generated csproj files build?). There are no unit tests for the tool's logic — parsing, resolving, updating. For a tool that generates MSBuild boilerplate, regression tests comparing expected vs actual XML output would catch bugs early.

### 15. Publish workflow doesn't run on a matrix

Not a problem today, but the tool generates backslash paths (#9) and runs on Linux CI. If cross-platform correctness ever matters, running the build-and-test workflow on both `windows-latest` and `ubuntu-latest` would catch path separator issues.

### 16. `fetch-depth: 0` in build-and-test

`build-and-test.yml` line 13 uses `fetch-depth: 0` (full clone). This is needed for MinVer versioning during the `dotnet pack` step, so it's correct — just noting it's intentional.

---

## Minor / Style

### 20. Inconsistent file naming: `CE` vs `Extensions` suffix

`StringCE.cs`, `XDocumentCE.cs` use "CE" (Class Extensions?), while `XNodeExtensions.cs`, `ProjectExtensions.cs` use "Extensions". Pick one convention.

---