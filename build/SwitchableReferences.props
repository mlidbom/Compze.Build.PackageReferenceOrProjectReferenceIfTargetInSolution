<Project>

  <!--
    SwitchableReferences.props — Shared MSBuild infrastructure for switching
    between ProjectReference and PackageReference based on solution context.

    Import this file in your Directory.Build.props BEFORE declaring any
    per-dependency flag derivation properties.

    See SwitchableReferences.README.md for full usage instructions.
  -->

  <!--
    Step 1: Locate the .slnx file.

    Two paths:

    A) VS/Rider/dotnet CLI — $(SolutionPath) is set by the IDE/CLI and
       points directly at the .slnx file.

    B) NCrunch — $(SolutionPath) is unreliable in NCrunch's isolated
       workspace. Set $(NcrunchSlnxRelativePathOverride) in the
       .v3.ncrunchsolution CustomBuildProperties to the .slnx path
       relative to Directory.Build.props. NCrunch must also be configured
       to copy the .slnx to its workspace via
       AdditionalFilesToIncludeForSolution.
  -->

  <!-- A) VS/Rider/dotnet CLI -->
  <PropertyGroup Condition="'$(NCrunch)' != '1'
                         And '$(SolutionPath)' != ''
                         And '$(SolutionPath)' != '*Undefined*'
                         And Exists('$(SolutionPath)')">
    <_SwitchRef_SlnxPath>$(SolutionPath)</_SwitchRef_SlnxPath>
  </PropertyGroup>

  <!-- B) NCrunch — resolve override path relative to Directory.Build.props -->
  <PropertyGroup Condition="'$(_SwitchRef_SlnxPath)' == ''
                         And '$(NCrunch)' == '1'
                         And '$(NcrunchSlnxRelativePathOverride)' != ''">
    <_SwitchRef_SlnxPath>$([MSBuild]::GetDirectoryNameOfFileAbove('$(MSBuildProjectDirectory)', 'Directory.Build.props'))$(NcrunchSlnxRelativePathOverride)</_SwitchRef_SlnxPath>
  </PropertyGroup>

  <!--
    Step 2: Parse the .slnx and extract project filenames.

    .slnx files list projects as XML like this:
        <Project Path="src/Acme.Core/Acme.Core.csproj" />

    The regex matches each <Project> element's Path attribute, captures
    the filename after the last /, and replaces the whole match with
    |filename|:

        <Project Path="src/Acme.Core/Acme.Core.csproj"  →  <Project |Acme.Core.csproj|

    The surrounding XML is kept but harmless — | never appears in
    normal XML content, so .Contains('|Acme.Core.csproj|') is an
    exact match against real project filenames.

    %28/%29 are MSBuild escapes for ( and ), &lt;/&gt; are XML escapes
    for < and >.

    The regex in normal notation:  <Project\s[^>]*Path="(?:[^"]*/)?([^"/]+)"

    $(_SwitchRef_SolutionProjects) is the public API for consumers.
  -->
  <PropertyGroup Condition="'$(_SwitchRef_SlnxPath)' != ''
                         And Exists('$(_SwitchRef_SlnxPath)')">
    <_SwitchRef_SolutionProjects>$([System.Text.RegularExpressions.Regex]::Replace(
        $([System.IO.File]::ReadAllText('$(_SwitchRef_SlnxPath)')),
        '&lt;Project\s[^&gt;]*Path="%28?:[^"]*/%29?%28[^"/]+%29"',
        '|$1|'))</_SwitchRef_SolutionProjects>
  </PropertyGroup>

  <!--
    Step 2: Per-dependency flag derivation.

    After importing this file, declare properties in your Directory.Build.props
    for each switchable dependency using this two-line pattern:

    <PropertyGroup>
      <_UsePackage_LibA Condition="'$(UsePackageReference_MyProj_LibA)' == 'true'">true</_UsePackage_LibA>
      <_UsePackage_LibA Condition="'$(_UsePackage_LibA)' != 'true'
                                 And '$(_SwitchRef_SolutionProjects)' != ''
                                 And !$(_SwitchRef_SolutionProjects.Contains('|LibA.csproj|'))">true</_UsePackage_LibA>
    </PropertyGroup>

    Line 1: Honours any explicit override (NCrunch Custom Build Properties / env var).
    Line 2: Checks the parsed project list — uses PackageReference only if we
             have solution context AND the project is NOT listed in it.
             The | delimiters ensure exact filename matching (no false positives
             from similarly-named projects like Company.LibA.csproj).

    If neither condition is met, the property stays empty/unset, which means
    the .csproj defaulting to ProjectReference (the safe default).
  -->

</Project>
